#!/bin/bash

export PYTHONDONTWRITEBYTECODE=1
export PY3=`which python3`

function help() {
    echo "bbox - bixin's micro service and rpc framework"
    echo "usage: bbox <command> [args] [options]"
    echo 'commands'
    echo ' init                      - init a bbox project'
    echo ' start modspec [modspec]   - start rpc server'
    echo ' httpd modspec             - start httpd to handler'
    echo ' metrics                   - prometheus metrics url'    
    echo ' run modspec [modspec]     - run tasks'
    echo ' rpc srv::method arg [arg] - trigger rpc request'
    echo ' config set sec/key value  - set shared config'
    echo ' config get <sec/key|sec>  - print shared config by key or section'
    echo ' config del <sec/key|sec>  - delete given config key'
    echo ' config clear              - clear all shared config'
    echo ' config dump|list          - dump all shared config'
    echo ' config load <config.json> - load config from json file'
    echo ' cluster info              - print boxes in the cluster'
}

case "$1" in
    init)
        exec $PY3 -m aiobbox.tools.initprj "${@:2}"
        ;;
    start)
        lang=`$PY3 -m aiobbox.tools.printticket language`
        if [ $lang == 'python3' ]; then
            exec $PY3 -m aiobbox.tools.startbox "${@:2}"
        else
            # TODO: support nodejs
            echo language $lang not supported
            exit 1
        fi
        ;;
    httpd)
        lang=`$PY3 -m aiobbox.tools.printcfg language`
        if [ $lang == 'python3' ]; then
            exec $PY3 -m aiobbox.tools.starthttpd "${@:2}"
        else
            # TODO: support nodejs
            echo language $lang not supported
            exit 1
        fi
        ;;
    metrics)
        
        exec $PY3 -m aiobbox.tools.startmetrics "${@:2}"
        ;;
    run)
        lang=`$PY3 -m aiobbox.tools.printcfg language`
        if [ $lang == 'python3' ]; then
            exec $PY3 -m aiobbox.tools.runtask "${@:2}"
        else
            # TODO: support nodejs
            echo language $lang not supported
            exit 1
        fi
        ;;
    rpc)
        exec $PY3 -m aiobbox.tools.rpcclient "${@:2}"
        ;;
    config)
        exec $PY3 -m aiobbox.tools.clusterconfig "${@:2}"
        ;;
    cluster)
        exec $PY3 -m aiobbox.tools.clusterop "${@:2}"
        ;;
    *)
        help
        ;;
esac
